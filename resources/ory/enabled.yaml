NAME: ory
LAST DEPLOYED: Wed Aug 10 15:33:45 2022
NAMESPACE: kyma-system
STATUS: pending-install
REVISION: 1
HOOKS:
---
# Source: ory/charts/hydra/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "ory-hydra-test-connection"
  namespace: kyma-system
  labels:
    "app.kubernetes.io/name": "hydra"
    "app.kubernetes.io/instance": "ory"
    "app.kubernetes.io/version": "v1.11.8"
    "app.kubernetes.io/managed-by": "Helm"
    "helm.sh/chart": "hydra-0.23.2"
  annotations:
    "helm.sh/hook": test-success
spec:
  containers:
    - name: healthcheck-ready
      image: "eu.gcr.io/kyma-project/external/busybox:1.34.1"
      command: ['wget']
      args:  ['ory-hydra-admin:4445/health/ready']
  restartPolicy: Never
MANIFEST:
---
# Source: ory/templates/psp.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: ory
  labels:
    release: ory
    helm.sh/chart: ory-1.1.0
    app.kubernetes.io/name: ory
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/instance: ory
spec:
  allowPrivilegeEscalation: false
  privileged: false
  hostNetwork: false
  hostIPC: false
  hostPID: false
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'MustRunAs'
    ranges:
      - min: 1
        max: 65535
  runAsUser:
    rule: 'MustRunAsNonRoot'
  supplementalGroups:
    rule: 'MustRunAs'
    ranges:
      - min: 1
        max: 65535
  volumes:
    - "secret"
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hydra-maester-account
  namespace:  kyma-system
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/dashboard-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ory-hydra-maester-dashboard
  labels:
    grafana_dashboard: "1"
    app: monitoring-grafana
data:
  ory-hydra-maester-dashboard.json: |-
    {
      "annotations": {
        "list": [
        {
          "builtIn": 1,
          "datasource": "-- Grafana --",
          "enable": true,
          "hide": true,
          "iconColor": "rgba(0, 211, 255, 1)",
          "name": "Annotations & Alerts",
          "type": "dashboard"
        }
        ]
      },
      "editable": false,
      "gnetId": null,
      "graphTooltip": 0,
      "links": [],
      "panels": [
      {
        "collapsed": false,
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 0
        },
        "id": 10,
        "panels": [],
        "title": "Application metrics",
        "type": "row"
      },
      {
        "aliasColors": {},
        "bars": false,
        "dashLength": 10,
        "dashes": false,
        "datasource": "Prometheus",
        "fill": 1,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 1
        },
        "id": 6,
        "legend": {
          "avg": false,
          "current": false,
          "max": false,
          "min": false,
          "show": true,
          "total": false,
          "values": false
        },
        "lines": true,
        "linewidth": 1,
        "links": [],
        "nullPointMode": "null",
        "paceLength": 10,
        "percentage": false,
        "pointradius": 2,
        "points": false,
        "renderer": "flot",
        "seriesOverrides": [],
        "stack": false,
        "steppedLine": false,
        "targets": [
        {
          "expr": "go_goroutines{service=\"ory-hydra-maester-metrics\"}",
          "format": "time_series",
          "intervalFactor": 1,
          "refId": "A",
          "legendFormat": "{{ pod }}"
        }
        ],
        "thresholds": [],
        "timeFrom": null,
        "timeRegions": [],
        "timeShift": null,
        "title": "Goroutines",
        "tooltip": {
          "shared": true,
          "sort": 0,
          "value_type": "individual"
        },
        "type": "graph",
        "xaxis": {
          "buckets": null,
          "mode": "time",
          "name": null,
          "show": true,
          "values": []
        },
        "yaxes": [
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
        ],
        "yaxis": {
          "align": false,
          "alignLevel": null
        }
      },
      {
        "aliasColors": {},
        "bars": false,
        "dashLength": 10,
        "dashes": false,
        "datasource": "Prometheus",
        "fill": 1,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 1
        },
        "id": 8,
        "legend": {
          "avg": false,
          "current": false,
          "max": false,
          "min": false,
          "show": true,
          "total": false,
          "values": false
        },
        "lines": true,
        "linewidth": 1,
        "links": [],
        "nullPointMode": "null",
        "paceLength": 10,
        "percentage": false,
        "pointradius": 2,
        "points": false,
        "renderer": "flot",
        "seriesOverrides": [],
        "stack": false,
        "steppedLine": false,
        "targets": [
        {
          "expr": "go_threads{service=\"ory-hydra-maester-metrics\"}",
          "format": "time_series",
          "intervalFactor": 1,
          "refId": "A",
          "legendFormat": "{{ pod }}"
        }
        ],
        "thresholds": [],
        "timeFrom": null,
        "timeRegions": [],
        "timeShift": null,
        "title": "Go threads",
        "tooltip": {
          "shared": true,
          "sort": 0,
          "value_type": "individual"
        },
        "type": "graph",
        "xaxis": {
          "buckets": null,
          "mode": "time",
          "name": null,
          "show": true,
          "values": []
        },
        "yaxes": [
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
        ],
        "yaxis": {
          "align": false,
          "alignLevel": null
        }
      },
      {
        "aliasColors": {},
        "bars": false,
        "dashLength": 10,
        "dashes": false,
        "datasource": "Prometheus",
        "fill": 1,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 9
        },
        "id": 12,
        "legend": {
          "avg": false,
          "current": false,
          "max": false,
          "min": false,
          "show": true,
          "total": false,
          "values": false
        },
        "lines": true,
        "linewidth": 1,
        "links": [],
        "nullPointMode": "null",
        "paceLength": 10,
        "percentage": false,
        "pointradius": 2,
        "points": false,
        "renderer": "flot",
        "seriesOverrides": [],
        "stack": false,
        "steppedLine": false,
        "targets": [
        {
          "expr": "go_gc_duration_seconds{service=\"ory-hydra-maester-metrics\"}",
          "format": "time_series",
          "intervalFactor": 1,
          "refId": "A",
          "legendFormat": "quantile: {{ quantile }} ({{ pod }})"
        }
        ],
        "thresholds": [],
        "timeFrom": null,
        "timeRegions": [],
        "timeShift": null,
        "title": "GC invocations durations",
        "tooltip": {
          "shared": true,
          "sort": 0,
          "value_type": "individual"
        },
        "type": "graph",
        "xaxis": {
          "buckets": null,
          "mode": "time",
          "name": null,
          "show": true,
          "values": []
        },
        "yaxes": [
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
        ],
        "yaxis": {
          "align": false,
          "alignLevel": null
        }
      },
      {
        "aliasColors": {},
        "bars": false,
        "dashLength": 10,
        "dashes": false,
        "datasource": "Prometheus",
        "fill": 1,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 9
        },
        "id": 16,
        "legend": {
          "avg": false,
          "current": false,
          "max": false,
          "min": false,
          "show": true,
          "total": false,
          "values": false
        },
        "lines": true,
        "linewidth": 1,
        "links": [],
        "nullPointMode": "null",
        "paceLength": 10,
        "percentage": false,
        "pointradius": 2,
        "points": false,
        "renderer": "flot",
        "seriesOverrides": [],
        "stack": false,
        "steppedLine": false,
        "targets": [
        {
          "expr": "go_memstats_heap_inuse_bytes{job=\"ory-hydra-maester-metrics\"}",
          "format": "time_series",
          "intervalFactor": 2,
          "legendFormat": "Heap in use",
          "refId": "A"
        },
        {
          "expr": "go_memstats_stack_inuse_bytes{job=\"ory-hydra-maester-metrics\"}",
          "format": "time_series",
          "intervalFactor": 2,
          "legendFormat": "Stack in use",
          "refId": "B"
        },
        {
          "expr": "container_memory_usage_bytes{container=~\"hydra-maester|istio-proxy\", pod=~\"ory-hydra-maester.*\"}",
          "format": "time_series",
          "intervalFactor": 2,
          "legendFormat": "{{ container }} (k8s)",
          "refId": "C"
        },
        {
          "expr": "sum(container_memory_usage_bytes{container=~\"hydra-maester|istio-proxy\", pod=~\"ory-hydra-maester.*\"})",
          "format": "time_series",
          "intervalFactor": 2,
          "legendFormat": "Total",
          "refId": "D"
        }
        ],
        "thresholds": [],
        "timeFrom": null,
        "timeRegions": [],
        "timeShift": null,
        "title": "Memory",
        "tooltip": {
          "shared": true,
          "sort": 0,
          "value_type": "individual"
        },
        "type": "graph",
        "xaxis": {
          "buckets": null,
          "mode": "time",
          "name": null,
          "show": true,
          "values": []
        },
        "yaxes": [
        {
          "format": "bytes",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
        ],
        "yaxis": {
          "align": false,
          "alignLevel": null
        }
      },
      {
        "collapsed": false,
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 17
        },
        "id": 4,
        "panels": [],
        "title": "Network metrics",
        "type": "row"
      },
      {
        "aliasColors": {},
        "bars": false,
        "dashLength": 10,
        "dashes": false,
        "datasource": "Prometheus",
        "fill": 1,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 18
        },
        "id": 20,
        "legend": {
          "avg": false,
          "current": false,
          "max": false,
          "min": false,
          "show": true,
          "total": false,
          "values": false
        },
        "lines": true,
        "linewidth": 1,
        "links": [],
        "nullPointMode": "null",
        "paceLength": 10,
        "percentage": false,
        "pointradius": 2,
        "points": false,
        "renderer": "flot",
        "seriesOverrides": [],
        "stack": false,
        "steppedLine": false,
        "targets": [
        {
          "expr": "sum(rate(http_requests_total{service=~\"ory-hydra-maester-metrics.*\"}[5m])) by (job)",
          "format": "time_series",
          "intervalFactor": 2,
          "refId": "A",
          "legendFormat": "{{ job }}"
        }
        ],
        "thresholds": [],
        "timeFrom": null,
        "timeRegions": [],
        "timeShift": null,
        "title": "Clients registered/s",
        "tooltip": {
          "shared": true,
          "sort": 0,
          "value_type": "individual"
        },
        "type": "graph",
        "xaxis": {
          "buckets": null,
          "mode": "time",
          "name": null,
          "show": true,
          "values": []
        },
        "yaxes": [
        {
          "format": "reqps",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
        ],
        "yaxis": {
          "align": false,
          "alignLevel": null
        }
      },
      {
        "aliasColors": {},
        "bars": false,
        "dashLength": 10,
        "dashes": false,
        "datasource": "Prometheus",
        "fill": 1,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 18
        },
        "id": 18,
        "legend": {
          "avg": false,
          "current": false,
          "max": false,
          "min": false,
          "show": true,
          "total": false,
          "values": false
        },
        "lines": true,
        "linewidth": 1,
        "links": [],
        "nullPointMode": "null",
        "paceLength": 10,
        "percentage": false,
        "pointradius": 2,
        "points": false,
        "renderer": "flot",
        "seriesOverrides": [],
        "stack": false,
        "steppedLine": false,
        "targets": [
        {
          "expr": "rate(http_requests_total{service=~\"ory-hydra-maester-metrics.*\",code=~\"5.*\"}[5m]) / rate(http_requests_total[5m])\n\n",
          "format": "time_series",
          "intervalFactor": 1,
          "refId": "A"
        }
        ],
        "thresholds": [],
        "timeFrom": null,
        "timeRegions": [],
        "timeShift": null,
        "title": "Hydra Calls HTTP Error Rates (5xx)",
        "tooltip": {
          "shared": true,
          "sort": 0,
          "value_type": "individual"
        },
        "type": "graph",
        "xaxis": {
          "buckets": null,
          "mode": "time",
          "name": null,
          "show": true,
          "values": []
        },
        "yaxes": [
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
        ],
        "yaxis": {
          "align": false,
          "alignLevel": null
        }
      },
      {
        "aliasColors": {},
        "bars": false,
        "dashLength": 10,
        "dashes": false,
        "datasource": "Prometheus",
        "fill": 1,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 26
        },
        "id": 2,
        "legend": {
          "avg": false,
          "current": false,
          "max": false,
          "min": false,
          "show": true,
          "total": false,
          "values": false
        },
        "lines": true,
        "linewidth": 1,
        "links": [],
        "nullPointMode": "null",
        "paceLength": 10,
        "percentage": false,
        "pointradius": 2,
        "points": false,
        "renderer": "flot",
        "seriesOverrides": [],
        "stack": false,
        "steppedLine": false,
        "targets": [
        {
          "expr": "sum by (code) (rate(http_requests_total{service=\"ory-hydra-maester-metrics\"}[5m]))",
          "format": "time_series",
          "intervalFactor": 2,
          "legendFormat": "{{ code }}",
          "refId": "A"
        }
        ],
        "thresholds": [],
        "timeFrom": null,
        "timeRegions": [],
        "timeShift": null,
        "title": "Request rate by status code",
        "tooltip": {
          "shared": true,
          "sort": 0,
          "value_type": "individual"
        },
        "type": "graph",
        "xaxis": {
          "buckets": null,
          "mode": "time",
          "name": null,
          "show": true,
          "values": []
        },
        "yaxes": [
        {
          "format": "reqps",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
        ],
        "yaxis": {
          "align": false,
          "alignLevel": null
        }
      },
      {
        "aliasColors": {},
        "bars": false,
        "dashLength": 10,
        "dashes": false,
        "datasource": "Prometheus",
        "fill": 1,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 26
        },
        "id": 14,
        "legend": {
          "avg": false,
          "current": false,
          "max": false,
          "min": false,
          "show": true,
          "total": false,
          "values": false
        },
        "lines": true,
        "linewidth": 1,
        "links": [],
        "nullPointMode": "null",
        "paceLength": 10,
        "percentage": false,
        "pointradius": 2,
        "points": false,
        "renderer": "flot",
        "seriesOverrides": [],
        "stack": false,
        "steppedLine": false,
        "targets": [
        {
          "expr": "sort_desc(sum by (pod) (rate(container_network_receive_bytes_total{pod=~\"ory-hydra-maester.*\"}[1m])))",
          "format": "time_series",
          "intervalFactor": 2,
          "refId": "A",
          "legendFormat": "{{ pod }}"
        }
        ],
        "thresholds": [],
        "timeFrom": null,
        "timeRegions": [],
        "timeShift": null,
        "title": "Network I/O",
        "tooltip": {
          "shared": true,
          "sort": 0,
          "value_type": "individual"
        },
        "type": "graph",
        "xaxis": {
          "buckets": null,
          "mode": "time",
          "name": null,
          "show": true,
          "values": []
        },
        "yaxes": [
        {
          "format": "bytes",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
        ],
        "yaxis": {
          "align": false,
          "alignLevel": null
        }
      }
      ],
      "schemaVersion": 18,
      "style": "dark",
      "tags": [
        "auth",
        "kyma"
      ],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "refresh": "10s",
      "timepicker": {
        "refresh_intervals": [
          "5s",
          "10s",
          "30s",
          "1m",
          "5m",
          "15m",
          "30m",
          "1h",
          "2h",
          "1d"
        ],
        "time_options": [
          "5m",
          "15m",
          "1h",
          "6h",
          "12h",
          "24h",
          "2d",
          "7d",
          "30d"
        ]
      },
      "timezone": "",
      "title": "Kyma / ORY / Hydra-maester",
      "version": 1
    }
---
# Source: ory/charts/hydra/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ory-hydra
  namespace: kyma-system
  labels:
    "app.kubernetes.io/name": "hydra"
    "app.kubernetes.io/instance": "ory"
    "app.kubernetes.io/version": "v1.11.8"
    "app.kubernetes.io/managed-by": "Helm"
    "helm.sh/chart": "hydra-0.23.2"
data:
  "config.yaml": |

    serve:
      admin:
        port: 4445
      public:
        port: 4444
      tls:
        allow_termination_from:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
    urls:
      self: {}
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/rbac-global.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: hydra-maester-role-global
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create"]
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/rbac.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: hydra-maester-role
rules:
  - apiGroups: ["hydra.ory.sh"]
    resources: ["oauth2clients", "oauth2clients/status"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["list", "watch"]
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/rbac-global.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: hydra-maester-role-binding-global
subjects:
  - kind: ServiceAccount
    name: hydra-maester-account # Service account assigned to the controller pod.
    namespace:  kyma-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: hydra-maester-role-global
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/rbac.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: hydra-maester-role-binding
subjects:
  - kind: ServiceAccount
    name: hydra-maester-account # Service account assigned to the controller pod.
    namespace:  kyma-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: hydra-maester-role
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: hydra-maester-sync-clients
  namespace: kyma-system
rules:
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["list", "patch", "get", "watch"]
    resourceNames:
      - ory-hydra
      - ory-hydra-maester
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hydra-maester-sync-clients
  namespace: kyma-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: hydra-maester-sync-clients
subjects:
  - kind: ServiceAccount
    name: hydra-maester-account
    namespace: kyma-system
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/service-metrics.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: hydra-maester
    helm.sh/chart: hydra-maester-0.23.2
    app.kubernetes.io/instance: ory
    app.kubernetes.io/version: "v0.0.25"
    app.kubernetes.io/managed-by: Helm
  name: ory-hydra-maester-metrics
spec:
  ports:
  - name: http-metrics
    port: 8080
  selector:
    app.kubernetes.io/instance: ory
    app.kubernetes.io/name: hydra-maester
---
# Source: ory/charts/hydra/templates/service-admin.yaml
apiVersion: v1
kind: Service
metadata:
  name: ory-hydra-admin
  namespace: kyma-system
  labels:
    "app.kubernetes.io/name": "hydra"
    "app.kubernetes.io/instance": "ory"
    "app.kubernetes.io/version": "v1.11.8"
    "app.kubernetes.io/managed-by": "Helm"
    "helm.sh/chart": "hydra-0.23.2"
    app.kubernetes.io/component: admin
spec:
  type: ClusterIP
  ports:
    - port: 4445
      targetPort: http-admin
      protocol: TCP
      name: http
    - port: 15020
      targetPort: 15020
      protocol: TCP
      name: tcp-status-port      
  selector:
    app.kubernetes.io/name: hydra
    app.kubernetes.io/instance: ory
---
# Source: ory/charts/hydra/templates/service-public.yaml
apiVersion: v1
kind: Service
metadata:
  name: ory-hydra-public
  namespace: kyma-system
  labels:
    "app.kubernetes.io/name": "hydra"
    "app.kubernetes.io/instance": "ory"
    "app.kubernetes.io/version": "v1.11.8"
    "app.kubernetes.io/managed-by": "Helm"
    "helm.sh/chart": "hydra-0.23.2"
spec:
  type: ClusterIP
  ports:
    - port: 4444
      targetPort: http-public
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: hydra
    app.kubernetes.io/instance: ory
---
# Source: ory/charts/postgresql/templates/svc-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: ory-postgresql-headless
  labels:
    app: postgresql
    chart: postgresql-11.1.26
    release: "ory"
    heritage: "Helm"
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: tcp-postgresql
      port: 5432
      targetPort: tcp-postgresql
  selector:
    app: postgresql
    release: "ory"
---
# Source: ory/charts/postgresql/templates/svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: ory-postgresql
  labels:
    app: postgresql
    chart: postgresql-11.1.26
    release: "ory"
    heritage: "Helm"
spec:
  type: ClusterIP
  ports:
    - name: tcp-postgresql
      port: 5432
      targetPort: tcp-postgresql
  selector:
    app: postgresql
    release: "ory"
    role: master
---
# Source: ory/charts/hydra/charts/hydra-maester/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ory-hydra-maester
  labels:
    app.kubernetes.io/name: hydra-maester
    helm.sh/chart: hydra-maester-0.23.2
    app.kubernetes.io/instance: ory
    app.kubernetes.io/version: "v0.0.25"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      control-plane: controller-manager
      app.kubernetes.io/name: hydra-maester
      app.kubernetes.io/instance: ory
  strategy:
    {}
  template:
    metadata:
      labels:
        control-plane: controller-manager
        app.kubernetes.io/name: hydra-maester
        app.kubernetes.io/instance: ory
    spec:
      containers:
        - name: hydra-maester
          image: "eu.gcr.io/kyma-project/external/oryd/hydra-maester:v0.0.25"
          imagePullPolicy: IfNotPresent
          command:
            - /manager
          args:
            - --metrics-addr=0.0.0.0:8080
            - --hydra-url=http://ory-hydra-admin
            - --hydra-port=4445
            - --sync-period=10h               
          resources:
            {}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            privileged: false
            runAsGroup: 1000
            runAsNonRoot: true
            runAsUser: 1000
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          ports:
            - containerPort: 8080
              name: metrics
          livenessProbe:
            httpGet:
              port: 8080
              path: "/metrics"
            initialDelaySeconds: 50
            timeoutSeconds: 1
            periodSeconds: 10
          readinessProbe:
            httpGet:
              port: 8080
              path: "/metrics"
            initialDelaySeconds: 10
            timeoutSeconds: 1
            periodSeconds: 2
      serviceAccountName: hydra-maester-account
      nodeSelector:
      volumes:
        - name: hydra-dsn
          secret:
            secretName: ory-hydra-credentials
---
# Source: ory/charts/hydra/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ory-hydra
  namespace: kyma-system
  labels:
    "app.kubernetes.io/name": "hydra"
    "app.kubernetes.io/instance": "ory"
    "app.kubernetes.io/version": "v1.11.8"
    "app.kubernetes.io/managed-by": "Helm"
    "helm.sh/chart": "hydra-0.23.2"
  annotations:
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: hydra
      app.kubernetes.io/instance: ory
  strategy:
    rollingUpdate:
      maxSurge: 50%
      maxUnavailable: 0%
    type: RollingUpdate
  template:
    metadata:
      labels:
        "app.kubernetes.io/name": "hydra"
        "app.kubernetes.io/instance": "ory"
        "app.kubernetes.io/version": "v1.11.8"
        "app.kubernetes.io/managed-by": "Helm"
        "helm.sh/chart": "hydra-0.23.2"
      annotations:        
        checksum/hydra-config: 25de285e88bdae68272e2c85b8bc29f43e517cd42db50f044770c8bffa5c6222
    spec:
      initContainers: #Use only for in-cluster databases that may not be ready yet. External databases are made ready before installation.
        - name: wait-for-db
          image: "eu.gcr.io/kyma-project/external/busybox:1.34.1"
          command:
            - /bin/sh
            - -c
            - |
              # DSN is always in the form DSN=DB_TYPE://DB_USER:PASSWORD@DB_URL/DB_NAME?sslmode=disable
              # But DSN for mysql is in the form DSN=DB_TYPE://DB_USER:PASSWORD@tcp(DB_URL)/DB_NAME?parseTime=true
              
              # Extract DB_TYPE to check if the DB_TYPE is mysql
              DB_TYPE_VALUE=$(echo $DSN | awk -F '://' '{print $1}')
              
              if [ $DB_TYPE_VALUE == "mysql" ]; then
                # Extract DB_URL by cutting between @ and first / and extracting the string between brackets
                DB_URL_PORT=$(echo $DSN | cut -d '@' -f2 | cut -d '/' -f 1 | cut -d "(" -f2 | cut -d ")" -f1)
              else
                # Extract DB_URL by cutting between @ and first /
                DB_URL_PORT=$(echo $DSN | cut -d '@' -f2 | cut -d '/' -f 1 )
              fi
              
              # DB_URL is expected to be mydb.mynamespace.svc.cluster.local:1234, but the port can be optional
              # Check if it given by looking for :
              if echo "$DB_URL_PORT" | grep -q ':'; then
                # Split URL and port by :
                DB_URL=$(echo $DB_URL_PORT | cut -d ':' -f 1)
                DB_PORT=$(echo $DB_URL_PORT | cut -d ':' -f 2)
              else
                # Use the full url, since no port was given
                DB_URL=$DB_URL_PORT
              fi
              
              # If port was given, we use it, if not, empty var is expanded to 0
              until nc -zv -w 5 $DB_URL $DB_PORT; do
                echo "$DB_URL not yet ready"
                sleep 5
              done
          env:
            - name: DSN
              valueFrom:
                secretKeyRef:
                  name: ory-hydra-credentials
                  key: dsn
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            privileged: false
            runAsGroup: 65534
            runAsNonRoot: true
            runAsUser: 65534
        - name: hydra-automigrate
          image: "eu.gcr.io/kyma-project/external/oryd/hydra:v1.11.8"
          imagePullPolicy: IfNotPresent
          command: ["hydra"]
          args: ["migrate", "sql", "-e", "--yes", "--config", "/etc/config/config.yaml"]
          volumeMounts:
            - name: hydra-config-volume
              mountPath: /etc/config
              readOnly: true
          env:
            - name: DSN
              valueFrom:
                secretKeyRef:
                  name: ory-hydra-credentials
                  key: dsn
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            privileged: false
            runAsGroup: 1000
            runAsNonRoot: true
            runAsUser: 1000
      volumes:
        - name: hydra-config-volume
          configMap:
            name: ory-hydra
      serviceAccountName: default
      automountServiceAccountToken: true
      containers:
        - name: hydra
          image: "eu.gcr.io/kyma-project/external/oryd/hydra:v1.11.8"
          imagePullPolicy: IfNotPresent
          command: ["hydra"]
          volumeMounts:
            - name: hydra-config-volume
              mountPath: /etc/config
              readOnly: true
          args: [
            "serve",
            "all",
            "--dangerous-force-http",
            "--config",
            "/etc/config/config.yaml"
          ]
          ports:
            - name: http-public
              containerPort: 4444
              protocol: TCP
            - name: http-admin
              containerPort: 4445
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /health/alive
              port: http-admin
            failureThreshold: 5
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http-admin
            failureThreshold: 5
            initialDelaySeconds: 30
            periodSeconds: 10
          env:
            - name: URLS_SELF_ISSUER
              value: "http://127.0.0.1:4444/"
            - name: DSN
              valueFrom:
                secretKeyRef:
                  name: ory-hydra-credentials
                  key: dsn
            - name: SECRETS_SYSTEM
              valueFrom:
                secretKeyRef:
                  name: ory-hydra-credentials
                  key: secretsSystem
            - name: SECRETS_COOKIE
              valueFrom:
                secretKeyRef:
                  name: ory-hydra-credentials
                  key: secretsCookie
          resources:
            limits:
              cpu: 500m
              memory: 256Mi
            requests:
              cpu: 10m
              memory: 128Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 100
          lifecycle:
            {}
---
# Source: ory/charts/hydra/templates/hpa.yaml
apiVersion: autoscaling/v2beta2
kind: HorizontalPodAutoscaler
metadata:
  namespace: kyma-system
  name: ory-hydra
  labels:
    "app.kubernetes.io/name": "hydra"
    "app.kubernetes.io/instance": "ory"
    "app.kubernetes.io/version": "v1.11.8"
    "app.kubernetes.io/managed-by": "Helm"
    "helm.sh/chart": "hydra-0.23.2"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ory-hydra
  minReplicas: 1
  maxReplicas: 3
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 80
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 75
---
# Source: ory/charts/postgresql/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ory-postgresql
  labels:
    app: postgresql
    chart: postgresql-11.1.26
    release: "ory"
    heritage: "Helm"
spec:
  serviceName: ory-postgresql-headless
  replicas: 1
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: postgresql
      release: "ory"
      role: master
  template:
    metadata:
      name: ory-postgresql
      labels:
        app: postgresql
        chart: postgresql-11.1.26
        release: "ory"
        heritage: "Helm"
        role: master
      annotations:
        sidecar.istio.io/inject: "false"
    spec:      
      securityContext:
        fsGroup: 70
        runAsNonRoot: true
      initContainers:
        # - name: do-something
        #   image: busybox
        #   command: ['do', 'something']
        
      containers:
        - name: ory-postgresql
          image: eu.gcr.io/kyma-project/external/postgres:11.15-alpine3.15
          imagePullPolicy: "IfNotPresent"
          resources:
            limits:
              cpu: 750m
              memory: 1024Mi
            requests:
              cpu: 100m
              memory: 256Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            privileged: false
            runAsNonRoot: true
            runAsUser: 70
          env:
            - name: BITNAMI_DEBUG
              value: "false"
            - name: POSTGRESQL_PORT_NUMBER
              value: "5432"
            - name: POSTGRESQL_VOLUME_DIR
              value: "/data/"
            - name: PGDATA
              value: "/data/pgdata"
            - name: POSTGRES_USER
              value: "hydra"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ory-hydra-credentials
                  key: postgresql-password
            - name: POSTGRES_DB
              value: "db4hydra"
            - name: POSTGRESQL_ENABLE_LDAP
              value: "no"
          ports:
            - name: tcp-postgresql
              containerPort: 5432
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - exec pg_isready -U "hydra" -d "db4hydra" -h 127.0.0.1 -p 5432
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - -e
                - |
                  exec pg_isready -U "hydra" -d "db4hydra" -h 127.0.0.1 -p 5432
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          volumeMounts:
            - name: dshm
              mountPath: /dev/shm
            - name: data
              mountPath: /data/
              subPath: 
      volumes:
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 1Gi
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - "ReadWriteOnce"
        resources:
          requests:
            storage: "8Gi"
---
# Source: ory/templates/db-postgresql-dr.yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: ory-postgresql
spec:
  host: ory-postgresql.kyma-system.svc.cluster.local
  trafficPolicy:
    tls:
      mode: DISABLE
---
# Source: ory/templates/monitoring-hydra.yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: ory-hydra-maester-metrics
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: ory
      app.kubernetes.io/name: hydra-maester
  portLevelMtls:
    8080:
      mode: PERMISSIVE
---
# Source: ory/templates/monitoring-hydra.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    prometheus: monitoring
    app: ory
    chart: "ory-1.1.0"
    release: "ory"
    heritage: "Helm"
  name: ory-hydra-maester
spec:
  endpoints:
  - port: http-metrics
    scheme: http
    metricRelabelings:
    - sourceLabels: [ __name__ ]
      regex: ^(go_gc_duration_seconds|go_goroutines|go_memstats_alloc_bytes|go_memstats_heap_alloc_bytes|go_memstats_heap_inuse_bytes|go_memstats_heap_sys_bytes|go_memstats_stack_inuse_bytes|go_threads|http_requests_total|process_cpu_seconds_total|process_max_fds|process_open_fds|process_resident_memory_bytes|process_start_time_seconds|process_virtual_memory_bytes|rest_client_request_latency_seconds_bucket|rest_client_requests_total|workqueue_adds_total|workqueue_depth|workqueue_queue_duration_seconds_bucket)$
      action: keep
    - sourceLabels: [__name__,le]
      regex: 'rest_client_request_latency_seconds_bucket;(0.002|0.008|0.032|0.128|0.512)' # drop buckets to reduce metric footprint
      action: drop
    - action: keep
      regex: ^rest_client_request_latency_seconds_bucket;https://.+(/api/v1.*|/apis/(apps|hydra.ory.sh).+)$ # allow metrics from core, apps and hydra API group
      sourceLabels: [__name__,url]
  namespaceSelector:
    matchNames:
      - "kyma-system"
  selector:
    matchLabels:
      app.kubernetes.io/instance: ory
      app.kubernetes.io/name: hydra-maester
---
# Source: ory/charts/hydra/templates/hydra-virtualservice.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ory-hydra
  namespace: kyma-system
spec:
  gateways:
    - kyma-system/kyma-gateway
  hosts:
    - oauth2.kyma.example.com
  http:
    - match:
        - uri:
            exact: "/oauth2/introspect"
      route:
        - destination:
            host: ory-hydra-admin
            port:
              number: 4445
    - match:
        - uri:
            prefix: "/.well-known"
        - uri:
            prefix: "/oauth2"
        - uri:
            exact: "/userinfo"
      route:
        - destination:
            host: ory-hydra-public
            port:
              number: 4444

